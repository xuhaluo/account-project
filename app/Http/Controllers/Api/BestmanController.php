<?php
/*
 本代码由 PHP代码加密工具 Xend(Build 5.00.08) 创建
 创建时间 2019-04-23 14:56:54
 技术支持 QQ:30370740 Mail:support@phpXend.com
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace App\Http\Controllers\Api;use App\Models\Procedure;use App\Models\Tactics;use App\Models\User;use App\Models\Charge;use App\Models\Follow;use App\Models\Shares;use App\Models\Setting;use App\Models\Storage;use Illuminate\Support\Facades\DB;use Illuminate\Http\Request;use Auth;use Log;class BestmanController extends Controller{public function getbestinfo(){if(Auth::check())goto H2tBodyx2;goto H2tNextx2;H2tBodyx2:$user_id=Auth::user()->id;$users=User::orderBy('yieldrate','desc')->select('id','name','tacticsnum','winsum','yieldrate')->limit(3)->get();$follows=Follow::where('user_id',$user_id)->get();$follow_user_ids=$follows->pluck('to_user_id')->toArray();foreach($users as $user){if(in_array($user->id,$follow_user_ids))goto H2tBodyx4;goto H2tNextx4;H2tBodyx4:$user->is_follow=true;goto H2tx3;H2tNextx4:$user->is_follow=false;H2tx3:}goto H2tx1;H2tNextx2:$users=User::orderBy('yieldrate','desc')->select('id','name','tacticsnum','winsum','yieldrate')->limit(3)->get();foreach($users as&$user){$user->is_follow=false;}H2tx1:return ['status'=>true,'data'=>$users];}public function bestmaninfo(Request $request){$user=Auth::user();$user_id=$user->id;$to_user_id=$request->to_user_id;$follow=Follow::where('user_id',$user_id)->where('to_user_id',$to_user_id)->first();if($follow)goto H2tBodyx6;goto H2tNextx6;H2tBodyx6:$data['focus']=1;goto H2tx5;H2tNextx6:$data['focus']=0;H2tx5:$users=User::where('id',$to_user_id)->first();$data['userinfo']=$users;$data['getdynamicinfo']=Tactics::join('shares','tactics.code','shares.code')->where('shares.is_del',0)->where('tactics.order_status',0)->where('user_id',$to_user_id)->select('shares.name','shares.code','tactics.id','tactics.num','tactics.price','tactics.created_at')->paginate(15);if($users)goto H2tBodyx8;goto H2tNextx8;H2tBodyx8:return ['status'=>200,'data'=>$data];goto H2tx7;H2tNextx8:return ['status'=>300,'data'=>'数据有误'];H2tx7:}public function morebestmaninfo(Request $request){$to_user_id=$request->to_user_id;$data=Tactics::join('shares','tactics.code','shares.code')->where('shares.is_del',0)->where('tactics.order_status',0)->where('user_id',$to_user_id)->select('shares.name','shares.code','tactics.id','tactics.num','tactics.price','tactics.created_at')->paginate(15);if($data)goto H2tBodyxa;goto H2tNextxa;H2tBodyxa:return ['status'=>200,'data'=>$data];goto H2tx9;H2tNextxa:return ['status'=>300,'data'=>'暂无数据'];H2tx9:}public function newfollowbuy(Request $request){$tactics_id=$request->id;$data=Tactics::where('id',$tactics_id)->first();if($data)goto H2tBodyxc;goto H2tNextxc;H2tBodyxc:return ['status'=>200,'data'=>$data];goto H2txb;H2tNextxc:return ['status'=>300,'data'=>'暂无数据'];H2txb:}public function followbuy(Request $request){$user=Auth::user();$tactics_id=$request->id;$data=Tactics::where('id',$tactics_id)->first();$code=$data->code;$xingyongjin=$data->xingyongjin;$multiple=$data->multiple;$max_price=$data->max_price;$min_price=$data->min_price;$is_add=$data->is_add;$is_sell=$data->is_sell;$ip=$request->getClientIp();$prices=get_price_moneys($code);if($prices)goto H2tBodyxe;goto H2tNextxe;H2tBodyxe:$nowPrice=$prices[0][4];goto H2txd;H2tNextxe:H2txd:$loss_ratio=Setting::where('code','loss_ratio')->first();$H2t0=!$loss_ratio;$H2t2=(bool)$H2t0;$H2t3=!$H2t2;if($H2t3)goto H2tBodyxh;goto H2tNextxh;H2tBodyxh:$H2t1=!is_numeric($loss_ratio->value);$H2t2=(bool)$H2t1;goto H2txg;H2tNextxh:H2txg:if($H2t2)goto H2tBodyxi;goto H2tNextxi;H2tBodyxi:return ['status'=>false,'msg'=>'系统错误！'];goto H2txf;H2tNextxi:H2txf:$is_min_price=round($nowPrice-$nowPrice*$loss_ratio->value/$multiple,2);$share=Shares::where('code',$code)->where('is_danger',1)->first();if($share)goto H2tBodyxk;goto H2tNextxk;H2tBodyxk:return ['status'=>false,'msg'=>'该股票为高风险股票禁止交易'];goto H2txj;H2tNextxk:H2txj:$H2t0=$is_min_price>$min_price;if($H2t0)goto H2tBodyxm;goto H2tNextxm;H2tBodyxm:return ['status'=>false,'msg'=>'最小值不能低于当前价的80%'];goto H2txl;H2tNextxm:H2txl:$H2t0=!$max_price;$H2t1=$H2t0>0;$H2t4=(bool)$H2t1;if($H2t4)goto H2tBodyxr;goto H2tNextxr;H2tBodyxr:$H2t2=!$min_price;$H2t3=$H2t2>0;$H2t4=(bool)$H2t3;goto H2txq;H2tNextxr:H2txq:$H2t7=(bool)$H2t4;if($H2t7)goto H2tBodyxp;goto H2tNextxp;H2tBodyxp:$H2t5=!$max_price;$H2t6=$H2t5>$min_price;$H2t7=(bool)$H2t6;goto H2txo;H2tNextxp:H2txo:if($H2t7)goto H2tBodyxs;goto H2tNextxs;H2tBodyxs:return ['status'=>false,'msg'=>'最大值或最小值必须大于0或最大值必须大于最小值'];goto H2txn;H2tNextxs:H2txn:$H2t0=!$code;if($H2t0)goto H2tBodyxu;goto H2tNextxu;H2tBodyxu:return ['status'=>false,'msg'=>'股票不能为空'];goto H2txt;H2tNextxu:H2txt:$H2t0=$xingyongjin>$user->money;$H2t2=(bool)$H2t0;if($H2t2)goto H2tBodyxx;goto H2tNextxx;H2tBodyxx:$H2t1=$user->money>0;$H2t2=(bool)$H2t1;goto H2txw;H2tNextxx:H2txw:if($H2t2)goto H2tBodyxy;goto H2tNextxy;H2tBodyxy:return ['status'=>false,'msg'=>'您的信用金不够请充值'];goto H2txv;H2tNextxy:H2txv:$H2t0=date('YmdHis') . rand(1000,9999);$order_no=$H2t0;$cangfeis=Storage::where('multiple',$multiple)->where('xingyongjin',$xingyongjin)->select('cangfei')->first();if($cangfeis)goto H2tBodyx11;goto H2tNextx11;H2tBodyx11:$cangfei=$cangfeis->cangfei;goto H2txz;H2tNextx11:$cangfei=0;H2txz:$H2t0=$xingyongjin+$cangfei;$create_money=$H2t0;$H2t0=ceil($xingyongjin*$multiple/$nowPrice/100)*100;$num=$H2t0;$row=Setting::where('code','diyanfei_base')->first();if($row)goto H2tBodyx13;goto H2tNextx13;H2tBodyx13:$H2t0=$row->value/10000;$H2t1=$H2t0*$xingyongjin;$H2t2=$H2t1*$multiple;$diyanfei=$H2t2;goto H2tx12;H2tNextx13:$diyanfei=0;H2tx12:DB::beginTransaction();try{$data=['user_id'=>$user->id,'profit'=>-$create_money,'ip'=>$ip,'status'=>1,'type'=>2,'order_no'=>$order_no,'info'=>$user->phone."用户".$user->id."创建订单".$create_money."元"];$this->addMoney($data);$tactics=Tactics::create(['user_id'=>$user->id,'code'=>$code,'price'=>$nowPrice,'order_status'=>0,'is_add'=>$is_add,'is_sell'=>$is_sell,'xingyongjin'=>$xingyongjin,'count_xingyongjin'=>$xingyongjin,'multiple'=>$multiple,'max_price'=>$max_price,'min_price'=>$min_price,'cangfei'=>$cangfei,'order_no'=>$order_no,'num'=>$num,'create_money'=>$create_money,'diyanfei'=>$diyanfei,]);DB::commit();return ['status'=>true,'msg'=>'订单创建成功'];}catch(\Exception $e){DB::rollback();return ['status'=>false,'msg'=>'订单创建失败'];}}public function addMoney($data){$user=User::lockForUpdate()->find($data['user_id']);$before_balance=$user->money;$H2t0=$user->money+$data['profit'];$user->money=$H2t0;$after_balance=$user->money;$H2t0=$user->money<0;if($H2t0)goto H2tBodyx16;goto H2tNextx16;H2tBodyx16:DB::rollback();exit();goto H2tx15;H2tNextx16:H2tx15:$r=$user->save();if(isset($data['card_id']))goto H2tBodyx18;goto H2tNextx18;H2tBodyx18:$H2t0=$data['card_id'];goto H2tx17;H2tNextx18:$H2t0=0;H2tx17:$card_id=$H2t0;$status=Charge::create(['card_id'=>$card_id,'user_id'=>$data['user_id'],'order_no'=>$data['order_no'],'status'=>$data['status'],'type'=>$data['type'],'before_balance'=>$before_balance,'after_balance'=>$after_balance,'info'=>$data['info'],'money'=>$data['profit']]);}}
?>