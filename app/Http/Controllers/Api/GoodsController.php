<?php
/*
 本代码由 PHP代码加密工具 Xend(Build 5.00.08) 创建
 创建时间 2019-04-23 14:56:54
 技术支持 QQ:30370740 Mail:support@phpXend.com
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace App\Http\Controllers\Api;use App\Models\Shares;use App\Models\Tactics;use App\Models\User;use App\Models\Setting;use Illuminate\Http\Request;use Illuminate\Support\Facades\DB;use Auth;class GoodsController extends Controller{public function accountCount(Request $request,$type){$types=['normal'=>'0','analog'=>'1'];$H2t0=!array_key_exists($type,$types);if($H2t0)goto H2tBodyx2;goto H2tNextx2;H2tBodyx2:return ['status'=>false,'msg'=>'系统错误！'];goto H2tx1;H2tNextx2:H2tx1:$user=Auth::user();$tactics=$user->tactics()->where('order_status',0)->where('is_analog',$types[$type])->whereIn('is_entrust',[1,6,7,99])->lockForUpdate()->get();$response=['float_earn'=>0,'market_value'=>0,'used'=>0,'can_use'=>0,'asset'=>0,];$codes=$tactics->pluck('code')->unique();$goods=[];foreach($codes as $code){$goods[$code]=getRealTimeInfo($code);}foreach($tactics as $tactic){$good=$goods[$tactic->code];if($good)goto H2tBodyx4;goto H2tNextx4;H2tBodyx4:$H2t0=$good['current_price'];goto H2tx3;H2tNextx4:$H2t0=$tactic->price;H2tx3:$current_price=$H2t0;$H2t0=$current_price-$tactic->price;$H2t1=$H2t0*$tactic->num;$response['float_earn']=$response['float_earn']+$H2t1;$H2t0=$current_price*$tactic->num;$response['market_value']=$response['market_value']+$H2t0;$response['used']=$response['used']+$tactic->count_xingyongjin;}$H2t0=$type=='normal';if($H2t0)goto H2tBodyx6;goto H2tNextx6;H2tBodyx6:$H2t0=(float)$user->money;$response['can_use']=$H2t0;goto H2tx5;H2tNextx6:$H2t0=$type=='analog';if($H2t0)goto H2tBodyx7;goto H2tNextx7;H2tBodyx7:$H2t0=(float)$user->analog_money;$response['can_use']=$H2t0;goto H2tx5;H2tNextx7:H2tx5:$H2t0=$response['can_use']+$response['used'];$H2t1=$H2t0+$response['float_earn'];$response['asset']=$H2t1;$response=collect($response)->map(function($item,$key){return round($item,2);});return ['status'=>true,'data'=>$response];}public function strategyChiCang(Request $request,$type){$types=['normal'=>'0','analog'=>'1'];$H2t0=!array_key_exists($type,$types);if($H2t0)goto H2tBodyx9;goto H2tNextx9;H2tBodyx9:return ['status'=>false,'msg'=>'系统错误！'];goto H2tx8;H2tNextx9:H2tx8:$user=Auth::user();$tactics=$user->tactics()->with(['shares','xingyongjin_appends'])->where('order_status',0)->whereIn('is_entrust',[1,6,7,99])->where('is_analog',$types[$type])->orderBy('created_at','desc')->get();$codes=$tactics->pluck('code')->unique();$response=[];$goods=$response;foreach($codes as $code){$goods[$code]=getRealTimeInfo($code);}$loss_ratio=Setting::where('code','loss_ratio')->first();$H2t0=!$loss_ratio;$H2t2=(bool)$H2t0;$H2t3=!$H2t2;if($H2t3)goto H2tBodyxc;goto H2tNextxc;H2tBodyxc:$H2t1=!is_numeric($loss_ratio->value);$H2t2=(bool)$H2t1;goto H2txb;H2tNextxc:H2txb:if($H2t2)goto H2tBodyxd;goto H2tNextxd;H2tBodyxd:return ['status'=>false,'msg'=>'系统错误！'];goto H2txa;H2tNextxd:H2txa:foreach($tactics as $tactic){$good=$goods[$tactic->code];if($good)goto H2tBodyxf;goto H2tNextxf;H2tBodyxf:$H2t0=$good['current_price'];goto H2txe;H2tNextxf:$H2t0=$tactic->price;H2txe:$current_price=$H2t0;$H2t0=$tactic->xingyongjin*$tactic->multiple;$all_trade=$H2t0;$H2t0=$tactic->count_xingyongjin*$loss_ratio->value;$xinyongjin_canuse=$H2t0;$H2t0=$all_trade-$xinyongjin_canuse;$H2t1=$H2t0<0;if($H2t1)goto H2tBodyxh;goto H2tNextxh;H2tBodyxh:$H2t2=0;goto H2txg;H2tNextxh:$H2t3=$all_trade-$xinyongjin_canuse;$H2t2=$H2t3;H2txg:$res=$H2t2;$min_min_price=round($res*$current_price/$all_trade,2);$tmp=['tactic_id'=>$tactic->id,'code'=>$tactic->code,'name'=>$tactic->shares->name,'price'=>$tactic->price,'current_price'=>$current_price,'num'=>$tactic->num,'cangfei'=>$tactic->cangfei,'market_value'=>round($current_price*$tactic->num,2),'rate'=>round((($current_price-$tactic->price)*$tactic->num)/$tactic->count_xingyongjin*100). '%','float_earn'=>round(($current_price-$tactic->price)*$tactic->num,2),'xingyongjin'=>$tactic->xingyongjin,'multiple'=>$tactic->multiple,'count_xingyongjin'=>$tactic->count_xingyongjin,'max_price'=>$tactic->max_price,'min_price'=>$tactic->min_price,'count_diyanfei'=>$tactic->count_diyanfei,'created_at'=>$tactic->created_at->format('m-d H:i'),'is_sell'=>$tactic->is_sell,'is_add'=>$tactic->is_add,'is_show'=>1,'min_min_price'=>$min_min_price,'xingyongjin_appends'=>$tactic->xingyongjin_appends->map(function($item,$key){$arr=$item->toArray();$arr['money']=abs($arr['money']);$arr['created_at']=date('m-d H:i',strtotime($arr['created_at']));return $arr;})];$response[]=$tmp;$H2t0=$tmp;}return ['status'=>true,'data'=>$response];}public function strategyChiCangPc(Request $request,$type){$types=['normal'=>'0','analog'=>'1'];$H2t0=!array_key_exists($type,$types);if($H2t0)goto H2tBodyxj;goto H2tNextxj;H2tBodyxj:return ['status'=>false,'msg'=>'系统错误！'];goto H2txi;H2tNextxj:H2txi:$user=Auth::user();$tactics=$user->tactics()->with(['shares'])->where('order_status',0)->whereIn('is_entrust',[1,6,7,99])->where('is_analog',$types[$type])->orderBy('created_at','desc')->paginate(5);$codes=$tactics->pluck('code')->unique();$response=[];$goods=$response;foreach($codes as $code){$goods[$code]=getRealTimeInfo($code);}$loss_ratio=Setting::where('code','loss_ratio')->first();$H2t0=!$loss_ratio;$H2t2=(bool)$H2t0;$H2t3=!$H2t2;if($H2t3)goto H2tBodyxm;goto H2tNextxm;H2tBodyxm:$H2t1=!is_numeric($loss_ratio->value);$H2t2=(bool)$H2t1;goto H2txl;H2tNextxm:H2txl:if($H2t2)goto H2tBodyxn;goto H2tNextxn;H2tBodyxn:return ['status'=>false,'msg'=>'系统错误！'];goto H2txk;H2tNextxn:H2txk:$responseData=$tactics->toArray();$response=[];foreach($responseData['data']as $tactic){$good=$goods[$tactic['code']];if($good)goto H2tBodyxp;goto H2tNextxp;H2tBodyxp:$H2t0=$good['current_price'];goto H2txo;H2tNextxp:$H2t0=$tactic['price'];H2txo:$current_price=$H2t0;$H2t0=$tactic['xingyongjin']*$tactic['multiple'];$all_trade=$H2t0;$H2t0=$tactic['count_xingyongjin']*$loss_ratio->value;$xinyongjin_canuse=$H2t0;$H2t0=$all_trade-$xinyongjin_canuse;$H2t1=$H2t0<0;if($H2t1)goto H2tBodyxr;goto H2tNextxr;H2tBodyxr:$H2t2=0;goto H2txq;H2tNextxr:$H2t3=$all_trade-$xinyongjin_canuse;$H2t2=$H2t3;H2txq:$res=$H2t2;$min_min_price=round($res*$current_price/$all_trade,2);$tmp=['tactic_id'=>$tactic['id'],'code'=>$tactic['code'],'name'=>$tactic['shares']['name'],'price'=>$tactic['price'],'current_price'=>$current_price,'num'=>$tactic['num'],'cangfei'=>$tactic['cangfei'],'market_value'=>round($current_price*$tactic['num'],2),'rate'=>round((($current_price-$tactic['price'])*$tactic['num'])/$tactic['count_xingyongjin']*100). '%','float_earn'=>round(($current_price-$tactic['price'])*$tactic['num'],2),'xingyongjin'=>$tactic['xingyongjin'],'multiple'=>$tactic['multiple'],'count_xingyongjin'=>$tactic['count_xingyongjin'],'max_price'=>$tactic['max_price'],'min_price'=>$tactic['min_price'],'count_diyanfei'=>$tactic['count_diyanfei'],'created_at'=>$tactic['created_at'],'is_sell'=>$tactic['is_sell'],'is_add'=>$tactic['is_add'],'is_show'=>0,'min_min_price'=>$min_min_price,];$response[]=$tmp;$H2t0=$tmp;}$responseData['data']=$response;return ['status'=>true,'data'=>$responseData];}public function strategyHistory(Request $request,$type){$types=['normal'=>'0','analog'=>'1'];$H2t0=!array_key_exists($type,$types);if($H2t0)goto H2tBodyxt;goto H2tNextxt;H2tBodyxt:return ['status'=>false,'msg'=>'系统错误！'];goto H2txs;H2tNextxt:H2txs:$user=Auth::user();$tactics=$user->tactics()->with(['shares','xingyongjin_appends'])->where('order_status',1)->where('is_analog',$types[$type])->orderBy('deal_time','desc')->get();$response=[];foreach($tactics as $tactic){$tmp=['tactic_id'=>$tactic->id,'code'=>$tactic->code,'name'=>$tactic->shares->name,'price'=>$tactic->price,'cangfei'=>$tactic->cangfei,'create_money'=>$tactic->create_money,'count_diyanfei'=>$tactic->count_diyanfei,'deal_money'=>$tactic->deal_money,'xingyongjin'=>$tactic->count_xingyongjin,'num'=>$tactic->num,'profit'=>$tactic->profit,'pingcang_type'=>$tactic->pingcang_type,'rate'=>$tactic->rate,'created_at'=>$tactic->created_at->format('m-d H:i'),'deal_time'=>$tactic->deal_time?(date('m-d H:i',strtotime($tactic->deal_time))):'','is_show'=>1,'xingyongjin_appends'=>$tactic->xingyongjin_appends->map(function($item,$key){$arr=$item->toArray();$arr['money']=abs($arr['money']);$arr['created_at']=date('m-d H:i',strtotime($arr['created_at']));return $arr;})];$response[]=$tmp;$H2t0=$tmp;}return ['status'=>true,'data'=>$response];}public function strategyHistoryPc(Request $request,$type){$types=['normal'=>'0','analog'=>'1'];$H2t0=!array_key_exists($type,$types);if($H2t0)goto H2tBodyxv;goto H2tNextxv;H2tBodyxv:return ['status'=>false,'msg'=>'系统错误！'];goto H2txu;H2tNextxv:H2txu:$user=Auth::user();$tactics=$user->tactics()->with(['shares'])->where('order_status',1)->where('is_analog',$types[$type])->orderBy('deal_time','desc')->paginate(5);$responseData=$tactics->toArray();$response=[];foreach($responseData['data']as $tactic){$tmp=['tactic_id'=>$tactic['id'],'code'=>$tactic['code'],'name'=>$tactic['shares']['name'],'price'=>$tactic['price'],'cangfei'=>$tactic['cangfei'],'create_money'=>$tactic['create_money'],'count_diyanfei'=>$tactic['count_diyanfei'],'deal_money'=>$tactic['deal_money'],'xingyongjin'=>$tactic['count_xingyongjin'],'num'=>$tactic['num'],'profit'=>$tactic['profit'],'pingcang_type'=>$tactic['pingcang_type'],'rate'=>$tactic['rate'],'created_at'=>$tactic['created_at'],'deal_time'=>$tactic['deal_time'],'is_show'=>0];$response[]=$tmp;$H2t0=$tmp;}$responseData['data']=$response;return ['status'=>true,'data'=>$responseData];}public function strategyEntrust(Request $request){$user=Auth::user();$tactics=$user->tactics()->with(['shares'])->whereIn('is_entrust',[0,2])->orderBy('created_at','desc')->get();$codes=$tactics->pluck('code')->unique();$response=[];$goods=$response;foreach($codes as $code){$goods[$code]=getRealTimeInfo($code);}$response=[];foreach($tactics as $tactic){$good=$goods[$tactic->code];$H2t0=!$good;if($H2t0)goto H2tBodyxx;goto H2tNextxx;H2tBodyxx:return ['status'=>false,'msg'=>'系统错误！'];goto H2txw;H2tNextxx:H2txw:if($good)goto H2tBodyxz;goto H2tNextxz;H2tBodyxz:$H2t0=$good['current_price'];goto H2txy;H2tNextxz:$H2t0=$tactic->price;H2txy:$current_price=$H2t0;$tmp=['tactic_id'=>$tactic->id,'code'=>$tactic->code,'name'=>$tactic->shares->name,'price'=>$tactic->price,'current_price'=>$current_price,'num'=>$tactic->num,'count_xingyongjin'=>$tactic->count_xingyongjin,'max_price'=>$tactic->max_price,'min_price'=>$tactic->min_price,'created_at'=>$tactic->created_at->toDateTimeString(),'out_in'=>$tactic->is_entrust,'is_show'=>1];$response[]=$tmp;$H2t0=$tmp;}return ['status'=>true,'data'=>$response];}public function strategyEntrustPc(Request $request){$user=Auth::user();$tactics=$user->tactics()->with(['shares'])->whereIn('is_entrust',[0,2])->orderBy('created_at','desc')->paginate(5);$codes=$tactics->pluck('code')->unique();$response=[];$goods=$response;foreach($codes as $code){$goods[$code]=getRealTimeInfo($code);}$responseData=$tactics->toArray();$response=[];foreach($responseData['data']as $tactic){$good=$goods[$tactic['code']];$H2t0=!$good;if($H2t0)goto H2tBodyx12;goto H2tNextx12;H2tBodyx12:return ['status'=>false,'msg'=>'系统错误！'];goto H2tx11;H2tNextx12:H2tx11:if($good)goto H2tBodyx14;goto H2tNextx14;H2tBodyx14:$H2t0=$good['current_price'];goto H2tx13;H2tNextx14:$H2t0=$tactic['price'];H2tx13:$current_price=$H2t0;$tmp=['tactic_id'=>$tactic['id'],'code'=>$tactic['code'],'name'=>$tactic['shares']['name'],'price'=>$tactic['price'],'current_price'=>$current_price,'num'=>$tactic['num'],'count_xingyongjin'=>$tactic['count_xingyongjin'],'max_price'=>$tactic['max_price'],'min_price'=>$tactic['min_price'],'created_at'=>$tactic['created_at'],'out_in'=>$tactic['is_entrust'],'is_show'=>0];$response[]=$tmp;$H2t0=$tmp;}$responseData['data']=$response;return ['status'=>true,'data'=>$responseData];}public function asset(){$user=Auth::user();$user_id=$user->id;$money=$user->money;$sum_count_xingyongjin=Tactics::where('user_id',$user_id)->where('order_status',0)->sum('count_xingyongjin');$profit=Tactics::where('user_id',$user_id)->where('order_status',0)->sum('profit');$H2t0=$money+$sum_count_xingyongjin;$estate=$H2t0;if($sum_count_xingyongjin)goto H2tBodyx16;goto H2tNextx16;H2tBodyx16:$H2t0=$sum_count_xingyongjin;goto H2tx15;H2tNextx16:$H2t0=0;H2tx15:$sum_count_xingyongjin=$H2t0;if($profit)goto H2tBodyx18;goto H2tNextx18;H2tBodyx18:$H2t0=$profit;goto H2tx17;H2tNextx18:$H2t0=0;H2tx17:$profit=$H2t0;if($estate)goto H2tBodyx1a;goto H2tNextx1a;H2tBodyx1a:$H2t0=$estate;goto H2tx19;H2tNextx1a:$H2t0=0;H2tx19:$estate=$H2t0;return ['status'=>true,'data'=>['estate'=>$estate,'sum_count_xingyongjin'=>$sum_count_xingyongjin,'profit'=>$profit,'money'=>$money]];}public function hot(){$shares=Shares::where('is_hot',1)->take(3)->orderBy('id','desc')->get();$plucked=$shares->pluck('code');$plucked->all();$plucked=$plucked->implode(',');$list=get_price_moneys($plucked);if($list)goto H2tBodyx1c;goto H2tNextx1c;H2tBodyx1c:return ['status'=>true,'data'=>$list];goto H2tx1b;H2tNextx1c:return ['status'=>false,'msg'=>'热门没有股票'];H2tx1b:}}
?>