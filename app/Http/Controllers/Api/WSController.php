<?php
/*
 本代码由 PHP代码加密工具 Xend(Build 5.00.08) 创建
 创建时间 2019-04-23 14:56:54
 技术支持 QQ:30370740 Mail:support@phpXend.com
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace App\Http\Controllers\Api;use App\Http\Controllers\Controller;use App\Admin\WebSocket;use App\Models\Tactics;use Illuminate\Support\Facades\DB;class WSController extends Controller{private $ws;public function old_Trade_QueryData(){set_time_limit(0);try{$H2t0=new WebSocket();$ws=$H2t0;$para=array("JsonType"=>0,"QueryType"=>2);$po['req']="Trade_QueryData";$po['rid']="3";$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);$H2t0=$para['QueryType']==3;if($H2t0)goto H2tBodyx3;goto H2tNextx3;H2tBodyx3:$H2t1=(bool)isset($message['data']);if($H2t1)goto H2tBodyx6;goto H2tNextx6;H2tBodyx6:$H2t0=!empty($message['data']);$H2t1=(bool)$H2t0;goto H2tx5;H2tNextx6:H2tx5:if($H2t1)goto H2tBodyx7;goto H2tNextx7;H2tBodyx7:$list=$message['data'];$i=0;H2tx8:$H2t0=$i<count($list);if($H2t0)goto H2tBodyxs;goto H2tNextxs;H2tBodyxs:$orderId=$list[$i]['委托编号'];$type=$list[$i]['买卖标志1'];$status=$list[$i]['状态说明'];$price=$list[$i]['成交价格'];$H2t0=$type=='买入';if($H2t0)goto H2tBodyxc;goto H2tNextxc;H2tBodyxc:$find=Tactics::where('buy_orderId',$orderId)->first();if($find)goto H2tBodyxe;goto H2tNextxe;H2tBodyxe:$H2t0=$status=='已成';if($H2t0)goto H2tBodyxg;goto H2tNextxg;H2tBodyxg:$find->is_entrust=1;$find->price=$price;goto H2txf;H2tNextxg:$H2t0=$status=='已报';$H2t2=(bool)$H2t0;$H2t3=!$H2t2;if($H2t3)goto H2tBodyxi;goto H2tNextxi;H2tBodyxi:$H2t1=$status=='未报';$H2t2=(bool)$H2t1;goto H2txh;H2tNextxi:H2txh:if($H2t2)goto H2tBodyxj;goto H2tNextxj;H2tBodyxj:$data['order_id']=$find->id;$data['type']=4;$data['orderId']=$orderId;$data['code']=$find->code;$this->Trade_CancelOrder($data);goto H2txf;H2tNextxj:$H2t0=$status=='已撤';if($H2t0)goto H2tBodyxk;goto H2tNextxk;H2tBodyxk:$find->is_entrust=5;$find->price=$price;goto H2txf;H2tNextxk:H2txf:$find->save();goto H2txd;H2tNextxe:H2txd:goto H2txb;H2tNextxc:$find=Tactics::where('sell_orderId',$orderId)->first();if($find)goto H2tBodyxm;goto H2tNextxm;H2tBodyxm:$H2t0=$status=='已成';if($H2t0)goto H2tBodyxo;goto H2tNextxo;H2tBodyxo:$find->is_entrust=3;$find->deal_money=$price;goto H2txn;H2tNextxo:$H2t0=$status=='已报';if($H2t0)goto H2tBodyxp;goto H2tNextxp;H2tBodyxp:$data['order_id']=$find->id;$data['type']=6;$data['orderId']=$orderId;$data['code']=$find->code;$this->Trade_CancelOrder($data);goto H2txn;H2tNextxp:$H2t0=$status=='已撤';if($H2t0)goto H2tBodyxq;goto H2tNextxq;H2tBodyxq:$find->is_entrust=7;$find->deal_money=$price;goto H2txn;H2tNextxq:H2txn:$find->save();goto H2txl;H2tNextxm:H2txl:H2txb:H2tx9:$i++;goto H2tx8;goto H2txr;H2tNextxs:H2txr:H2txa:goto H2tx4;H2tNextx7:H2tx4:goto H2tx2;H2tNextx3:print_r($message);H2tx2:}catch(\Exception $e){\Log::info($e->getMessage().'--'.$e->getLine());}}public function Trade_QueryData(){$H2t0=new WebSocket();$this->ws=$H2t0;H2txt:if(true)goto H2tBodyx1s;goto H2tNextx1s;H2tBodyx1s:file_put_contents(dirname(__FILE__).'/query.txt',date('Y-m-d H:i:s')."---------------start----------------
",FILE_APPEND);$para=array("JsonType"=>0,"QueryType"=>3);$po=[];$po['req']="Trade_QueryData";$po['rid']="3";$po['para']=$para;$po=json_encode($po);$this->ws->send($po);$message=json_decode($this->ws->receive(),true);$H2t0=$para['QueryType']==3;if($H2t0)goto H2tBodyxw;goto H2tNextxw;H2tBodyxw:$H2t1=(bool)isset($message['data']);if($H2t1)goto H2tBodyxz;goto H2tNextxz;H2tBodyxz:$H2t0=!empty($message['data']);$H2t1=(bool)$H2t0;goto H2txy;H2tNextxz:H2txy:if($H2t1)goto H2tBodyx11;goto H2tNextx11;H2tBodyx11:$list=$message['data'];$H2t0=!is_array($list);$H2t2=(bool)$H2t0;if($H2t2)goto H2tBodyx14;goto H2tNextx14;H2tBodyx14:$H2t1=!isset($list[0]);$H2t2=(bool)$H2t1;goto H2tx13;H2tNextx14:H2tx13:if($H2t2)goto H2tBodyx15;goto H2tNextx15;H2tBodyx15:goto H2txt;goto H2tx12;H2tNextx15:H2tx12:$i=0;H2tx16:$H2t0=$i<count($list);if($H2t0)goto H2tBodyx1q;goto H2tNextx1q;H2tBodyx1q:$orderId=$list[$i]['委托编号'];$type=$list[$i]['买卖标志1'];$status=$list[$i]['状态说明'];$price=$list[$i]['成交价格'];$H2t0=$type=='买入';if($H2t0)goto H2tBodyx1a;goto H2tNextx1a;H2tBodyx1a:$find=Tactics::where('buy_orderId',$orderId)->whereIn('is_entrust',[0,4])->lockForUpdate()->first();if($find)goto H2tBodyx1c;goto H2tNextx1c;H2tBodyx1c:$H2t0=$status=='已成';if($H2t0)goto H2tBodyx1e;goto H2tNextx1e;H2tBodyx1e:$find->is_entrust=1;$find->price=$price;goto H2tx1d;H2tNextx1e:$H2t0=$status=='已报';$H2t2=(bool)$H2t0;$H2t3=!$H2t2;if($H2t3)goto H2tBodyx1g;goto H2tNextx1g;H2tBodyx1g:$H2t1=$status=='未报';$H2t2=(bool)$H2t1;goto H2tx1f;H2tNextx1g:H2tx1f:if($H2t2)goto H2tBodyx1h;goto H2tNextx1h;H2tBodyx1h:$data['order_id']=$find->id;$data['type']=4;$data['orderId']=$orderId;$data['code']=$find->code;$this->Trade_CancelOrder($data);goto H2tx1d;H2tNextx1h:$H2t0=$status=='已撤';if($H2t0)goto H2tBodyx1i;goto H2tNextx1i;H2tBodyx1i:$find->is_entrust=5;$find->price=$price;goto H2tx1d;H2tNextx1i:H2tx1d:$find->save();goto H2tx1b;H2tNextx1c:H2tx1b:goto H2tx19;H2tNextx1a:$find=Tactics::where('sell_orderId',$orderId)->whereIn('is_entrust',[2,6])->lockForUpdate()->first();if($find)goto H2tBodyx1k;goto H2tNextx1k;H2tBodyx1k:$H2t0=$status=='已成';if($H2t0)goto H2tBodyx1m;goto H2tNextx1m;H2tBodyx1m:$find->is_entrust=3;$find->deal_money=$price;goto H2tx1l;H2tNextx1m:$H2t0=$status=='已报';if($H2t0)goto H2tBodyx1n;goto H2tNextx1n;H2tBodyx1n:$data['order_id']=$find->id;$data['type']=6;$data['orderId']=$orderId;$data['code']=$find->code;$this->Trade_CancelOrder($data);goto H2tx1l;H2tNextx1n:$H2t0=$status=='已撤';if($H2t0)goto H2tBodyx1o;goto H2tNextx1o;H2tBodyx1o:$find->is_entrust=7;$find->deal_money=$price;goto H2tx1l;H2tNextx1o:H2tx1l:$find->save();goto H2tx1j;H2tNextx1k:H2tx1j:H2tx19:H2tx17:$i++;goto H2tx16;goto H2tx1p;H2tNextx1q:H2tx1p:H2tx18:goto H2txx;H2tNextx11:H2txx:goto H2txv;H2tNextxw:H2txv:sleep(1);goto H2txt;goto H2tx1r;H2tNextx1s:H2tx1r:H2txu:}public function Trade_QueryHisData(){try{$H2t0=new WebSocket();$ws=$H2t0;$para=array("JsonType"=>0,"QueryType"=>1,"BeginDay"=>"20181226",'EndDay'=>"20181227");$po['req']="Trade_QueryHisData";$po['rid']="4";$po['type']=1;$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);print_r($message);}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();echo $H2t1;}}public function Trade_QueryQuote(){try{$H2t0=new WebSocket();$ws=$H2t0;$para=array("Server"=>2,"Codes"=>'002610');$po['req']="Trade_QueryQuote";$po['rid']="5";$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);print_r($message);}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();echo $H2t1;}}public function Trade_CommitOrder($process){$H2t0=new WebSocket();$this->ws=$H2t0;H2tx1v:if(true)goto H2tBodyx2c;goto H2tNextx2c;H2tBodyx2c:file_put_contents(dirname(__FILE__).'/'.$process.'.txt',date('Y-m-d H:i:s')."---------------process_id-".$process."---------------
",FILE_APPEND);$tactics=Tactics::where('order_status',0)->where('process_id',$process)->where(function($query){$query->where(function($query){$query->where('is_entrust',0)->where('buy_orderId',0);})->orWhere(function($query){$query->where('is_entrust',2)->where('sell_orderId',0);});})->lockForUpdate()->get();if($tactics)goto H2tBodyx1y;goto H2tNextx1y;H2tBodyx1y:$codes=$tactics->pluck('code')->unique()->implode(',');$goods=getRealTimeInfos($codes);foreach($tactics as $tactic){$po=[];DB::beginTransaction();try{$a=substr($tactic->code,0,2);$code=substr($tactic->code,2);$H2t0=$a=='sz';if($H2t0)goto H2tBodyx22;goto H2tNextx22;H2tBodyx22:$EType=1;goto H2tx21;H2tNextx22:$EType=2;H2tx21:$H2t0=$tactic->is_entrust==0;if($H2t0)goto H2tBodyx24;goto H2tNextx24;H2tBodyx24:$price=round($goods[$tactic->code]['yesterday_end_price']*1.1,2);$OType=1;goto H2tx23;H2tNextx24:$price=round($goods[$tactic->code]['yesterday_end_price']*0.9,2);$OType=2;H2tx23:$para=array(array("Count"=>$tactic->num,"Code"=>$code,'EType'=>$EType,'OType'=>$OType,'PType'=>1,'Price'=>$price));$po['req']="Trade_CommitOrder";$po['rid']="6";$po['para']=$para;$po=json_encode($po);$this->ws->send($po);$message=json_decode($this->ws->receive(),true);$rec1=json_decode($this->ws->receive(),true);$H2t0=$message['ret']==0;$H2t1=(bool)$H2t0;if($H2t1)goto H2tBodyx27;goto H2tNextx27;H2tBodyx27:$H2t1=(bool)isset($rec1['data']);goto H2tx26;H2tNextx27:H2tx26:if($H2t1)goto H2tBodyx28;goto H2tNextx28;H2tBodyx28:file_put_contents(dirname(__FILE__).'/'.$process.'.txt',date('Y-m-d H:i:s')."---------------".$rec1['data'][0]['委托编号']."----------------
",FILE_APPEND);$orderId=$rec1['data'][0]['委托编号'];$H2t0=$OType==1;if($H2t0)goto H2tBodyx2a;goto H2tNextx2a;H2tBodyx2a:$tactic->buy_orderId=$orderId;$tactic->save();goto H2tx29;H2tNextx2a:$tactic->sell_orderId=$orderId;$tactic->save();H2tx29:goto H2tx25;H2tNextx28:H2tx25:DB::commit();}catch(\Exception $e){DB::rollback();}}goto H2tx1x;H2tNextx1y:$this->ws->send('pengpengpeng');H2tx1x:file_put_contents(dirname(__FILE__).'/'.$process.'.txt',date('Y-m-d H:i:s')."---------------process_id-".$process."结束----------------
",FILE_APPEND);sleep(1);goto H2tx1v;goto H2tx2b;H2tNextx2c:H2tx2b:H2tx1w:}public function old_Trade_CommitOrder($data){try{$a=substr($data['code'],0,2);$code=substr($data['code'],2);$H2t0=$a=='sz';if($H2t0)goto H2tBodyx2g;goto H2tNextx2g;H2tBodyx2g:$EType=1;goto H2tx2f;H2tNextx2g:$EType=2;H2tx2f:$H2t0=$data['OType']==1;if($H2t0)goto H2tBodyx2i;goto H2tNextx2i;H2tBodyx2i:$price=round($data['price']*1.1,2);goto H2tx2h;H2tNextx2i:$price=round($data['price']*0.9,2);H2tx2h:$H2t0=new WebSocket();$ws=$H2t0;$para=array(array("Count"=>$data['count'],"Code"=>$code,'EType'=>$EType,'OType'=>$data['OType'],'PType'=>1,'Price'=>$price));$po['req']="Trade_CommitOrder";$po['rid']="6";$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);$rec1=json_decode($ws->receive(),true);$H2t0=$message['ret']==0;$H2t1=(bool)$H2t0;if($H2t1)goto H2tBodyx2l;goto H2tNextx2l;H2tBodyx2l:$H2t1=(bool)isset($rec1['data']);goto H2tx2k;H2tNextx2l:H2tx2k:if($H2t1)goto H2tBodyx2m;goto H2tNextx2m;H2tBodyx2m:$orderId=$rec1['data'][0]['委托编号'];$H2t0=$data['OType']==1;if($H2t0)goto H2tBodyx2o;goto H2tNextx2o;H2tBodyx2o:Tactics::where('id',$data['order_id'])->update(array('buy_orderId'=>$orderId,'is_entrust'=>0));goto H2tx2n;H2tNextx2o:Tactics::where('id',$data['order_id'])->update(array('sell_orderId'=>$orderId,'is_entrust'=>2));H2tx2n:$success=['status'=>true,'msg'=>'实盘操作成功'];return $success;goto H2tx2j;H2tNextx2m:$error=['status'=>false,'msg'=>'实盘操作失败'];return $error;H2tx2j:}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();$msg=$H2t1;$error=['status'=>false,'msg'=>$msg];return $error;}}public function Trade_CancelOrder($data){try{$a=substr($data['code'],0,2);$H2t0=$a=='sz';if($H2t0)goto H2tBodyx2r;goto H2tNextx2r;H2tBodyx2r:$Type=1;goto H2tx2q;H2tNextx2r:$Type=2;H2tx2q:$para=array("OrderID"=>$data['orderId'],"Type"=>$Type);$po['req']="Trade_CancelOrder";$po['rid']="7";$po['para']=$para;$po=json_encode($po);$this->ws->send($po);$message=json_decode($this->ws->receive(),true);$H2t0=$message['ret']==0;$H2t1=(bool)$H2t0;if($H2t1)goto H2tBodyx2u;goto H2tNextx2u;H2tBodyx2u:$H2t1=(bool)isset($message['data']);goto H2tx2t;H2tNextx2u:H2tx2t:if($H2t1)goto H2tBodyx2v;goto H2tNextx2v;H2tBodyx2v:$orderId=$message['data'][0]['委托编号'];DB::beginTransaction();$res1=Tactics::where('id',$data['order_id'])->update(array('cancel_orderId'=>$orderId,'is_entrust'=>$data['type']));$H2t0=new TacticsController();$tac=$H2t0;$res2=$tac->revokeTactic($data['order_id']);$H2t0=(bool)$res1;if($H2t0)goto H2tBodyx2y;goto H2tNextx2y;H2tBodyx2y:$H2t0=(bool)$res2;goto H2tx2x;H2tNextx2y:H2tx2x:if($H2t0)goto H2tBodyx3z;goto H2tNextx3z;H2tBodyx3z:DB::commit();$success=['status'=>true,'msg'=>'操作成功'];return $success;goto H2tx2w;H2tNextx3z:DB::rollback();$error=['status'=>false,'msg'=>'操作失败'];return $error;H2tx2w:goto H2tx2s;H2tNextx2v:$error=['status'=>false,'msg'=>'操作失败'];return $error;H2tx2s:}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();echo $H2t1;}}public function old_Trade_CancelOrder($data){try{$a=substr($data['code'],0,2);$H2t0=$a=='sz';if($H2t0)goto H2tBodyx33;goto H2tNextx33;H2tBodyx33:$Type=1;goto H2tx32;H2tNextx33:$Type=2;H2tx32:$H2t0=new WebSocket();$ws=$H2t0;$para=array("OrderID"=>$data['orderId'],"Type"=>$Type);$po['req']="Trade_CancelOrder";$po['rid']="7";$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);$H2t0=$message['ret']==0;$H2t1=(bool)$H2t0;if($H2t1)goto H2tBodyx36;goto H2tNextx36;H2tBodyx36:$H2t1=(bool)isset($message['data']);goto H2tx35;H2tNextx36:H2tx35:if($H2t1)goto H2tBodyx37;goto H2tNextx37;H2tBodyx37:$orderId=$message['data'][0]['委托编号'];DB::beginTransaction();$res1=Tactics::where('id',$data['order_id'])->update(array('cancel_orderId'=>$orderId,'is_entrust'=>$data['type']));$H2t0=new TacticsController();$tac=$H2t0;$res2=$tac->revokeTactic($data['order_id']);$H2t0=(bool)$res1;if($H2t0)goto H2tBodyx3a;goto H2tNextx3a;H2tBodyx3a:$H2t0=(bool)$res2;goto H2tx39;H2tNextx3a:H2tx39:if($H2t0)goto H2tBodyx3b;goto H2tNextx3b;H2tBodyx3b:DB::commit();$success=['status'=>true,'msg'=>'操作成功'];return $success;goto H2tx38;H2tNextx3b:DB::rollback();$error=['status'=>false,'msg'=>'操作失败'];return $error;H2tx38:goto H2tx34;H2tNextx37:$error=['status'=>false,'msg'=>'操作失败'];return $error;H2tx34:}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();echo $H2t1;}}public function Trade_IPO(){try{$H2t0=new WebSocket();$ws=$H2t0;$para=array("Version"=>1);$po['req']="Trade_IPO";$po['rid']="8";$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);print_r($message);}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();echo $H2t1;}}public function Trade_SellAll(){try{$H2t0=new WebSocket();$ws=$H2t0;$para=array("EType"=>1,'PType'=>5);$po['req']="Trade_SellAll";$po['rid']="9";$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);print_r($message);}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();echo $H2t1;}}public function Trade_TradableCount(){try{$H2t0=new WebSocket();$ws=$H2t0;$para=array("Code"=>'002610','EType'=>1,'OType'=>1,'PType'=>1,'Price'=>'1.67');$po['req']="Trade_TradableCount";$po['rid']="10";$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);print_r($message);}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();echo $H2t1;}}public function Trade_CheckStatus(){try{$H2t0=new WebSocket();$ws=$H2t0;$para=array("Server"=>2);$po['req']="Trade_CheckStatus";$po['rid']="11";$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);print_r($message);}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();echo $H2t1;}}public function Trade_LogOut(){try{$H2t0=new WebSocket();$ws=$H2t0;$para=array("Server"=>2,"ID"=>2);$po['req']="Trade_LogOut";$po['rid']="12";$po['para']=$para;$po=json_encode($po);$ws->send($po);$message=json_decode($ws->receive(),true);print_r($message);}catch(\Exception $e){$H2t0=$e->getMessage() . '--';$H2t1=$H2t0 . $e->getLine();echo $H2t1;}}}
?>