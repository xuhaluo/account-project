<?php
/*
 本代码由 PHP代码加密工具 Xend(Build 5.00.08) 创建
 创建时间 2019-04-23 14:56:54
 技术支持 QQ:30370740 Mail:support@phpXend.com
 严禁反编译、逆向等任何形式的侵权行为，违者将追究法律责任
*/

namespace App\Http\Controllers\Api;use App\Http\Requests\Api\SelfstockRequest;use App\Models\Selfstock;use App\Models\Shares;use App\Transformers\SelfstockTransformer;use Illuminate\Http\Request;use App\Models\User;use Auth;use Illuminate\Support\Facades\Cache;use Illuminate\Support\Facades\DB;class SelfstockController extends Controller{public function index(Request $request){$page=$request->page;$limit=10;$H2t0=$page-1;$H2t1=$H2t0*$limit;$offset=$H2t1;$user_id=Auth::user()->id;$selfstock=Selfstock::where('user_id',$user_id)->offset($offset)->limit($limit)->orderBy('id','desc')->select('code')->get();$plucked=$selfstock->pluck('code');$plucked->all();$plucked=$plucked->implode(',');$list=get_price_moneys($plucked);if($list)goto H2tBodyx2;goto H2tNextx2;H2tBodyx2:return ['status'=>true,'data'=>$list];goto H2tx1;H2tNextx2:return ['status'=>false,'msg'=>'没有自选股'];H2tx1:}public function store(Request $request,Selfstock $selfstock){$user_id=Auth::user()->id;$code=$request->code;$H2t0=!$code;if($H2t0)goto H2tBodyx4;goto H2tNextx4;H2tBodyx4:return ['status'=>false,'msg'=>'股票代码不能为空'];goto H2tx3;H2tNextx4:H2tx3:$selfstock=Selfstock::where('user_id',$user_id)->where('code',$code)->first();$share=Shares::where('code',$code)->select('name')->first();$H2t0=!$share;if($H2t0)goto H2tBodyx6;goto H2tNextx6;H2tBodyx6:return ['status'=>false,'请输入正确的股票代码'];goto H2tx5;H2tNextx6:H2tx5:$status=Selfstock::firstOrCreate(['user_id'=>Auth::user()->id,'code'=>$code,'name'=>$share->name,]);if($status)goto H2tBodyx8;goto H2tNextx8;H2tBodyx8:return ['status'=>true,'msg'=>'添加到自选股票！'];goto H2tx7;H2tNextx8:return ['status'=>false,'msg'=>'添加失败！'];H2tx7:}public function destroy(Request $request,Selfstock $selfstock){$user_id=Auth::user()->id;$code=$request->code;Selfstock::where('user_id',$user_id)->where('code',$code)->delete();return ['status'=>true,'msg'=>'删除自选股票成功！'];}public function search(Request $request){$user=Auth::user();$code=$request->code;$shares=collect([]);if($code)goto H2tBodyxa;goto H2tNextxa;H2tBodyxa:$shares=DB::table('selfstocks')->where(function($query)use($code){$query->where('code','like',"%".$code."%")->orwhere('name','like',"%".$code."%");})->where('user_id',$user->id)->limit(10)->get(['name','code']);goto H2tx9;H2tNextxa:H2tx9:$codes=$shares->implode('code',',');$goods=getRealTimeInfos($codes);$new_shares=$shares->map(function($item)use($goods){if(isset($goods[$item->code])){$item->current_price=$goods[$item->code]['current_price'];$item->up_ratio=$goods[$item->code]['up_ratio'];}return $item;});return ['status'=>true,'data'=>$new_shares];}public function getprice(){$user_id=Auth::user()->id;$selfstock=Selfstock::where('user_id',$user_id)->get();$collection=collect([]);if($selfstock)goto H2tBodyxc;goto H2tNextxc;H2tBodyxc:$selfstock->map(function($item,$key)use($collection){$price=get_price($item->code);$item->price=['name'=>$price[0],'todayOpening'=>$price[1],'closePriceYesterday'=>$price[2],'nowPrice'=>$price[3],];});return ['status_code'=>200,'selfstock'=>$selfstock];goto H2txb;H2tNextxc:H2txb:}}
?>